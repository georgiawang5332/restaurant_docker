<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç™»å…¥</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #error-message { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ” è«‹ç™»å…¥</h2>
  <form id="login-form">
    <label>å¸³è™Ÿï¼š<input type="text" id="username" required></label><br><br>
    <label>å¯†ç¢¼ï¼š<input type="password" id="password" required></label><br><br>
    <button type="submit">ç™»å…¥</button>
  </form>
  <div id="error-message"></div>
  <script>
    $('#login-form').submit(function (event) {
      event.preventDefault();
      const username = $('#username').val().trim();
      const password = $('#password').val().trim();
      if (!username || !password) {
        $('#error-message').text('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼');
        return;
      }
      $.ajax({
        url: '/api/token/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ username, password }),
        success: function (response) {
          // âœ… å„²å­˜ token
          localStorage.setItem('token', response.access);
          
          // âœ… è§£æä¸¦å„²å­˜éæœŸæ™‚é–“
          try {
            const payloadBase64 = response.access.split('.')[1];
            const payloadJson = atob(payloadBase64);
            const payload = JSON.parse(payloadJson);
            const exp = payload.exp * 1000; // è½‰æ›ç‚ºæ¯«ç§’
            localStorage.setItem('token_exp', exp);
          } catch (err) {
            console.error("JWT è§£ç¢¼å¤±æ•—", err);
          }
          
          // âœ… å°å‘ä¸»é 
          window.location.href = '/';
        },
        error: function (xhr) {
          let msg = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼';
          try {
            const res = JSON.parse(xhr.responseText);
            if (res.detail) msg = res.detail;
          } catch (e) {}
          $('#error-message').text(msg);
        }
      });
    });
  </script>
</body>
</html>