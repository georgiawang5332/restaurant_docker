{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>èœå–®ç®¡ç†</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        #timer { 
            position: fixed; 
            top: 10px; 
            right: 20px; 
            background-color: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .countdown { color: #dc3545; font-weight: bold; }
        #menu-list li {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        button {
            padding: 5px 10px;
            cursor: pointer;
        }
        #logout-btn {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            position: absolute;
            top: 10px;
            left: 20px;
        }
        .delete-btn {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            margin-left: 10px;
        }
        #add-item-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-top: 40px;">ğŸ½ï¸ ä»Šæ—¥é£²æ–™èœå–®</h1>
    
    <!-- ç™»å‡ºæŒ‰éˆ• -->
    <button id="logout-btn">ç™»å‡º</button>

    <!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
    <div id="timer">
        ç™»å…¥å‰©é¤˜æ™‚é–“ï¼š<span class="countdown">è¨ˆç®—ä¸­...</span>
    </div>

    <!-- æ–°å¢èœå–®é …ç›® -->
    <h2>æ–°å¢èœå–®é …ç›®</h2>
    <form id="add-item-form">
        <input type="text" id="name" placeholder="åç¨±" required>
        <input type="number" id="price" placeholder="åƒ¹æ ¼" required step="0.01">
        <button type="submit">æ–°å¢</button>
    </form>

    <!-- èœå–®åˆ—è¡¨ -->
    <div id="loading-menu">
        <span class="spinner"></span> è¼‰å…¥èœå–®ä¸­...
    </div>
    <ul id="menu-list"></ul>

    <!-- è‡ªè¨‚éŒ¯èª¤è¨Šæ¯è¦–çª— -->
    <div id="error-modal" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%);
        background:#fff; padding:20px; border:2px solid #f44336; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
        <p id="error-message" style="color:#f44336;"></p>
        <button onclick="$('#error-modal').hide()">é—œé–‰</button>
    </div>

    <!-- ç¢ºèªåˆªé™¤å°è©±æ¡† -->
    <div id="confirm-modal" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%);
        background:#fff; padding:20px; border:2px solid #007bff; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
        <p>ç¢ºå®šè¦åˆªé™¤é€™å€‹èœå–®é …ç›®å—ï¼Ÿ</p>
        <button id="confirm-yes">ç¢ºå®š</button>
        <button id="confirm-no">å–æ¶ˆ</button>
    </div>

    <script>
        $(document).ready(function () {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login/';
                return;
            }

            // â° è§£æ JWT éæœŸæ™‚é–“ä¸¦è¨­å®šè‡ªå‹•ç™»å‡º
            let tokenExp;
            try {
                // å…ˆå¾ localStorage ä¸­å–å¾—ä¹‹å‰å­˜çš„éæœŸæ™‚é–“
                tokenExp = localStorage.getItem('token_exp');
                
                // å¦‚æœæ²’æœ‰å­˜éï¼Œå°±å¾ token è§£æ
                if (!tokenExp) {
                    const payloadBase64 = token.split('.')[1];
                    const payloadJson = atob(payloadBase64);
                    const payload = JSON.parse(payloadJson);
                    tokenExp = payload.exp * 1000; // æ¯«ç§’
                    localStorage.setItem('token_exp', tokenExp);
                } else {
                    // è½‰æ›ç‚ºæ•¸å­—
                    tokenExp = parseInt(tokenExp);
                }
                
                const now = Date.now();
                const timeout = tokenExp - now;

                if (timeout > 0) {
                    // è¨­å®šè‡ªå‹•ç™»å‡º
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        localStorage.removeItem('token_exp');
                        alert('ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
                        window.location.href = '/login/';
                    }, timeout);
                    
                    // è¨­å®šå€’æ•¸è¨ˆæ™‚é¡¯ç¤º
                    startCountdown(tokenExp);
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('token_exp');
                    alert('ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
                    window.location.href = '/login/';
                    return;
                }
            } catch (err) {
                console.error("JWT è§£ç¢¼å¤±æ•—", err);
                localStorage.removeItem('token');
                localStorage.removeItem('token_exp');
                window.location.href = '/login/';
                return;
            }

            // â³ å€’æ•¸è¨ˆæ™‚å™¨
            function startCountdown(expTime) {
                function updateCountdown() {
                    const now = Date.now();
                    const remaining = expTime - now;
                    
                    if (remaining <= 0) {
                        $('.countdown').text('å·²éæœŸ');
                        return;
                    }
                    
                    // è¨ˆç®—åˆ†é˜å’Œç§’æ•¸
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    
                    // æ ¼å¼åŒ–é¡¯ç¤º
                    $('.countdown').text(`${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`);
                }
                
                // ç«‹å³æ›´æ–°ä¸€æ¬¡
                updateCountdown();
                
                // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                setInterval(updateCountdown, 1000);
            }

            // Ajax é è¨­è¨­å®š
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    const csrftoken = $('meta[name="csrf-token"]').attr('content');
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
            });

            // é¡¯ç¤ºèœå–®åˆ—è¡¨
            $.ajax({
                url: '/api/menu-items/',
                method: 'GET',
                success: function(data) {
                    $('#loading-menu').hide();
                    $('#menu-list').empty();
                    
                    if (data.length === 0) {
                        $('#menu-list').html('<p>ç›®å‰æ²’æœ‰èœå–®é …ç›®</p>');
                        return;
                    }
                    
                    data.forEach(function(item) {
                        $('#menu-list').prepend(
                            `<li data-id="${item.id}">
                                ${item.name} - $${parseFloat(item.price).toFixed(2)}
                                <button class="delete-btn">åˆªé™¤</button>
                            </li>`
                        );
                    });
                },
                error: function(xhr) {
                    $('#loading-menu').hide();
                    if (xhr.status === 401) {
                        $('#menu-list').html('<p>æ‚¨çš„ç™»å…¥å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹<a href="/login/">é‡æ–°ç™»å…¥</a></p>');
                    } else if (xhr.status === 403) {
                        $('#menu-list').html('<p>æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹èœå–®</p>');
                    } else {
                        $('#menu-list').html('<p>ç„¡æ³•è¼‰å…¥èœå–®ï¼Œè«‹ç¨å¾Œå†è©¦</p>');
                        console.error('è¼‰å…¥èœå–®å¤±æ•—:', xhr);
                    }
                }
            });

            // æ–°å¢èœå–®é …ç›®
            $('#add-item-form').submit(function (event) {
                event.preventDefault();
                const name = $('#name').val().trim();
                const price = parseFloat($('#price').val());

                if (!name || isNaN(price) || price <= 0) {
                    showError("è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±èˆ‡åƒ¹æ ¼");
                    return;
                }

                const newItem = { name, price };
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.text();
                
                submitBtn.html('<span class="spinner"></span> è™•ç†ä¸­...');
                submitBtn.prop('disabled', true);
                
                $.ajax({
                    url: '/api/menu-items/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(newItem),
                    success: function (data) {
                        $('#menu-list').prepend(
                            `<li data-id="${data.id}">
                                ${data.name} - $${parseFloat(data.price).toFixed(2)}
                                <button class="delete-btn">åˆªé™¤</button>
                            </li>`
                        );
                        $('#name').val('');
                        $('#price').val('');
                    },
                    error: function (xhr) {
                        handleError(xhr);
                    },
                    complete: function() {
                        submitBtn.html(originalText);
                        submitBtn.prop('disabled', false);
                    }
                });
            });

            // åˆªé™¤åŠŸèƒ½ - éœ€ç¢ºèª
            let itemToDelete = null;
            let deleteItemId = null;
            
            $('#menu-list').on('click', '.delete-btn', function() {
                itemToDelete = $(this).closest('li');
                deleteItemId = itemToDelete.data('id');
                $('#confirm-modal').show();
            });
            
            $('#confirm-yes').click(function() {
                if (!itemToDelete || !deleteItemId) {
                    $('#confirm-modal').hide();
                    return;
                }
                
                const deleteBtn = $(this);
                const originalText = deleteBtn.text();
                deleteBtn.html('<span class="spinner"></span> è™•ç†ä¸­...');
                deleteBtn.prop('disabled', true);
                
                $.ajax({
                    url: `/api/menu-items/${deleteItemId}/`,
                    method: 'DELETE',
                    success: function () {
                        itemToDelete.remove();
                        $('#confirm-modal').hide();
                    },
                    error: function (xhr) {
                        $('#confirm-modal').hide();
                        handleError(xhr);
                    },
                    complete: function() {
                        deleteBtn.html(originalText);
                        deleteBtn.prop('disabled', false);
                        itemToDelete = null;
                        deleteItemId = null;
                    }
                });
            });
            
            $('#confirm-no').click(function() {
                $('#confirm-modal').hide();
                itemToDelete = null;
                deleteItemId = null;
            });

            // ç™»å‡º
            $('#logout-btn').click(function () {
                localStorage.removeItem('token');
                localStorage.removeItem('token_exp');
                alert('å·²ç™»å‡º');
                window.location.href = '/login/';
            });

            // éŒ¯èª¤è™•ç†é¡¯ç¤ºè¨Šæ¯
            function handleError(xhr) {
                let msg = "æ“ä½œå¤±æ•—";
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (xhr.status === 401) {
                        msg = "ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥";
                        setTimeout(function() {
                            localStorage.removeItem('token');
                            localStorage.removeItem('token_exp');
                            window.location.href = '/login/';
                        }, 2000);
                    } else if (xhr.status === 403) {
                        msg = "æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ";
                    } else if (response.detail) {
                        msg = response.detail;
                    }
                } catch (e) {
                    console.error("è§£æéŒ¯èª¤å›æ‡‰å¤±æ•—", e);
                }
                
                showError(msg);
            }

            function showError(message) {
                $('#error-message').text(message);
                $('#error-modal').show();
            }
        });
    </script>
</body>
</html>