{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>èœå–®é é¢</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    {% csrf_token %}
    <h1>ğŸ½ï¸ ä»Šæ—¥èœå–®</h1>
    <h2>æ–°å¢èœå–®é …ç›®</h2>
    <form id="add-item-form">
        <!-- {{ csrf_token }} -->
        <input type="text" id="name" placeholder="åç¨±" required>
        <input type="number" id="price" placeholder="åƒ¹æ ¼" required step="0.01">
        <button type="submit">æ–°å¢</button>
    </form>
    <ul id="menu-list">
        <!-- èœå–®é …ç›®æœƒå‹•æ…‹å‡ºç¾åœ¨é€™è£¡ -->
    </ul>

    <script>
        $(document).ready(function () {
    // âœ… ä¸€é€²ä¾†å°±æª¢æŸ¥ tokenï¼Œæœ‰å•é¡Œå°±å°å›ç™»å…¥é 
    const token = localStorage.getItem('token');
    if (!token) {
      alert('è«‹å…ˆç™»å…¥ï¼');
      window.location.href = 'login';

      return;
    }
    // âœ… æœ‰ token çš„è©±æ‰ alert å‡ºä¾†
    alert("access token: " + token);
    console.log("access token: " + token);

    // âœ… é€™è£¡æ‰è¨­å®š Ajax çš„é è¨­ headersï¼ˆæœ‰ token æ‰è¨­ï¼‰
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        const csrftoken = $('meta[name="csrf-token"]').attr('content');
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }

        // åŠ ä¸Š JWT token
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      }
    });

    // âœ… æ‹¿å–èœå–®åˆ—è¡¨è³‡æ–™
    $.get('/api/menu-items/', function(data) {
      $('#menu-list').empty(); // â† æ¸…ç©ºåˆ—è¡¨
      data.forEach(function(item) {
        $('#menu-list').append(
          `<li data-id="${item.id}">
              ${item.name} - $${item.price}
              <button class="delete-btn">åˆªé™¤</button>
          </li>`
        );
      });
    });

    // ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½
    $('#menu-list').on('click', '.delete-btn', function() {
      const li = $(this).closest('li');
      const itemId = li.data('id');

      $.ajax({
        url: `/api/menu-items/${itemId}/`,
        method: 'DELETE',
        success: function () {
          li.remove();
        },
        error: function (xhr) {
          alert('åˆªé™¤å¤±æ•—ï¼š' + xhr.responseText);
        }
      });
    });

    // â• æ–°å¢èœå–®é …ç›®
    $('#add-item-form').submit(function (event) {
      event.preventDefault();
      const name = $('#name').val().trim();
      const price = parseFloat($('#price').val());

      if (!name) {
        alert('åç¨±ä¸èƒ½ç©ºç™½ï¼');
        return;
      }

      if (isNaN(price) || price <= 0) {
        alert('åƒ¹æ ¼å¿…é ˆæ˜¯æ­£æ•¸ï¼');
        return;
      }

      const newItem = { name, price };

      $.ajax({
        url: '/api/menu-items/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(newItem),
        success: function (data) {
          $('#menu-list').append(
            `<li data-id="${data.id}">
              ${data.name} - $${data.price}
              <button class="delete-btn">åˆªé™¤</button>
            </li>`
          );
          $('#name').val('');
          $('#price').val('');
        },
        error: function (xhr) {
          alert('æ–°å¢å¤±æ•—ï¼š' + xhr.responseText);
        }
      });
    });
  });
        // // ğŸ›¡ï¸ é€™æ®µè¦æ”¾æœ€å‰é¢
        // $.ajaxSetup({
        //   beforeSend: function(xhr, settings) {
        //     // CSRF Token
        //     const csrftoken = $('meta[name="csrf-token"]').attr('content');
        //     if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
        //       xhr.setRequestHeader("X-CSRFToken", csrftoken);
        //     }
        //     // JWT Token
        //     const token = localStorage.getItem('token');
        //     if (token) {
        //         xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        //       } else {
        //       console.warn("âš ï¸ æ‰¾ä¸åˆ° JWT tokenï¼Œè«‹å…ˆç™»å…¥ï¼");
        //     }
        //   }
        // });
        
        // // è¼‰å…¥è³‡æ–™
        // $(document).ready(function() {
        //   // ä¸€é€²ä¾†å°±æª¢æŸ¥æœ‰æ²’æœ‰ tokenï¼Œæ²’æœ‰å°±å°å›ç™»å…¥é é¢
        //     const token = localStorage.getItem('token');
        //     if (!token) {
        //       alert('è«‹å…ˆç™»å…¥ï¼');
        //       window.location.href = 'login.html';
        //       return; // â›” ä¸­æ­¢å¾Œé¢åŸ·è¡Œ
        //     }

        //     $.get('/api/menu-items/', function(data) {
        //         $('#menu-list').empty(); // â† æ¸…ç©ºåˆ—è¡¨å†é‡è¼‰
        //         data.forEach(function(item) {
        //             $('#menu-list').append(
        //                 `<li data-id="${item.id}">
        //                     ${item.name} - $${item.price}
        //                     <button class="delete-btn">åˆªé™¤</button>
        //                 </li>`
        //             );
        //         });
        //     });
        // });

        // // ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½ï¼ˆå§”æ´¾ç¶å®šï¼‰
        // $('#menu-list').on('click', '.delete-btn', function() {
        //     const li = $(this).closest('li');
        //     const itemId = li.data('id');

        //     $.ajax({
        //         url: '/api/menu-items/${itemId}/',
        //         // url: '/api/menu-items/', // ğŸ§  â† é€™å€‹ä¸€å®šè¦åŠ ä¸Šï¼
        //         method: 'DELETE',
        //         success: function() {
        //             li.remove(); // æˆåŠŸå¾Œå¾ç•«é¢ä¸­ç§»é™¤
        //         },
        //         error: function(xhr) {
        //             alert('åˆªé™¤å¤±æ•—ï¼š' + xhr.responseText);
        //         }
        //     });
        // });
        
        // // è¡¨å–®é€å‡º; // æ–°å¢èœå–®é …ç›®
        // $('#add-item-form').submit(function(event) {
        //     event.preventDefault(); // ä¸è¦è®“è¡¨å–®è‡ªå‹•é‡æ–°æ•´ç†; ä¸è¦é€å‡ºè¡¨å–®

        //     const name = $('#name').val().trim();
        //     const price = parseFloat($('#price').val());

        //     if (!name) {
        //       alert('åç¨±ä¸èƒ½ç©ºç™½ï¼'); //é˜²æ­¢ç©ºç™½ã€éŒ¯èª¤è¼¸å…¥
        //       return;
        //     }

        //     if (isNaN(price) || price <= 0) {
        //       alert('åƒ¹æ ¼å¿…é ˆæ˜¯æ­£æ•¸ï¼');//æ”¹å–„ä½¿ç”¨é«”é©—
        //       return;
        //     }

        //     const newItem = { name: name, price: price };

        //     $.ajax({
        //         url: '/api/menu-items/',
        //         method: 'POST',
        //         contentType: 'application/json',
        //         data: JSON.stringify(newItem),
        //         success: function(data) {
        //           console.log('æ–°å¢æˆåŠŸï¼Œå›å‚³è³‡æ–™ï¼š', data);
        //           $('#menu-list').append(`<li data-id="${data.id}">
        //             ${data.name} - $${data.price}
        //             <button class="delete-btn">åˆªé™¤</button></li>`);
        //           $('#name').val('');
        //           $('#price').val('');
        //         },
        //         error: function(xhr, status, error) {
        //           console.log('éŒ¯èª¤è¨Šæ¯:', xhr.responseText);
        //           alert('æ–°å¢å¤±æ•—ï¼š' + xhr.responseText);
        //         }
        //     });

        // });

        // // ç™»å…¥JWT 
        // $('#login-form').submit(function (event) {
        //     event.preventDefault();

        //     const credentials = {
        //         username: $('#username').val(),
        //         password: $('#password').val()
        //     };

        //     $.ajax({
        //         url: '/api/token/',
        //         method: 'POST',
        //         contentType: 'application/json',
        //         data: JSON.stringify(credentials),
        //         success: function(response) {
        //             // âœ… é€™é‚Šè¦åŠ ä¸Šé€™ä¸€è¡Œ
        //             localStorage.setItem('token', response.access);

        //             alert('ç™»å…¥æˆåŠŸï¼');
        //             location.reload(); // â† çœ‹ä½ è¦è½‰è·³æˆ– reload é é¢éƒ½è¡Œ
        //         },
        //         error: function(xhr) {
        //             alert('ç™»å…¥å¤±æ•—ï¼š' + xhr.responseText);
        //         }
        //     });
        // });

    </script>
</body>
</html>


<!-- 
ğŸ‰ æˆåŠŸå¾Œä½ æœƒå­¸åˆ°ï¼š
å¦‚ä½•ç”¨ jQuery å‘¼å« API
å¦‚ä½•æŠŠ API è³‡æ–™ã€Œæ’å…¥ã€ç¶²é ä¸­
Django REST + jQuery å‰å¾Œç«¯æ•´åˆçš„ç¬¬ä¸€æ­¥å®Œæˆï¼
 -->